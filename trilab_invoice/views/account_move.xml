<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="report_invoice_document" inherit_id="account.report_invoice_document"
            name="trilab_report_invoice_document" primary="True">

    <!-- add word buyer above customer block -->
    <xpath expr="//address/../*[1]" position="before">
      <strong t-if="o.move_type in ['out_invoice', 'out_refund']">Buyer:</strong>
    </xpath>

    <!-- add "NET" to the label -->
    <xpath expr="//table[@name='invoice_line_table']//th[@name='th_priceunit']/span" position="replace">
      <span>Unit price NET</span>
    </xpath>

    <xpath expr="//table[@name='invoice_line_table']/tbody[hasclass('invoice_tbody')]//span[@t-field='line.price_unit']"
           position="replace">
      <span t-out="(line.price_subtotal / line.quantity) if line.quantity != 0.0 else 0.0"
            t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
    </xpath>

    <xpath expr="//table[@name='invoice_line_table']/thead/tr/th[@name='th_subtotal']" position="replace">
      <th name="th_subtotal" class="text-right">
        <span groups="account.group_show_line_subtotals_tax_excluded">NET amount</span>
        <span groups="account.group_show_line_subtotals_tax_included">GROSS amount</span>
      </th>
    </xpath>

    <!-- add sale date -->
    <xpath expr="//div[@name='due_date']" position="before">
      <div class="col-auto mw-100 mb-2" t-if="o.x_invoice_sale_date" name="x_invoice_sale_date">
        <strong>Sale Date:</strong>
        <p class="m-0" t-field="o.x_invoice_sale_date"/>
      </div>
    </xpath>

    <!-- hide invoice_date_due for advance invoices-->
    <xpath expr="//div[@name='due_date']" position="attributes">
      <attribute name="t-if" separator=" and " add="not o.advance_source_id"/>
    </xpath>

    <h2 position="replace">
      <h2>
        <t t-if="not o.advance_source_id and not o.advance_invoices_ids">
          <span t-if="o.move_type == 'out_invoice' and o.state == 'posted'">Invoice</span>
          <span t-if="o.move_type == 'out_invoice' and o.state == 'draft'">Draft Invoice</span>
          <span t-if="o.move_type == 'out_invoice' and o.state == 'cancel'">Cancelled Invoice</span>
        </t>
        <t t-if="o.advance_invoices_ids">
          <span t-if="o.move_type == 'out_invoice' and o.state == 'posted'">Final Invoice</span>
          <span t-if="o.move_type == 'out_invoice' and o.state == 'draft'">Draft Final Invoice</span>
          <span t-if="o.move_type == 'out_invoice' and o.state == 'cancel'">Cancelled Final Invoice</span>
        </t>
        <t t-if="o.advance_source_id">
          <span t-if="o.move_type == 'out_invoice' and o.state == 'posted'">Advance Invoice</span>
          <span t-if="o.move_type == 'out_invoice' and o.state == 'draft'">Pro Forma Invoice</span>
          <span t-if="o.move_type == 'out_invoice' and o.state == 'cancel'">Cancelled Advance Invoice</span>
        </t>
        <span t-if="o.move_type == 'out_refund'">Correction Invoice</span>
        <span t-if="o.move_type == 'in_refund'">Vendor Correction Invoice</span>
        <span t-if="o.move_type == 'in_invoice'">Vendor Bill</span>
        <span t-if="o.name != '/'" t-field="o.name"/>
        <t t-if="o.x_invoice_duplicate_date">
          <br/><span class="text-small">Duplicate on <span t-out="o.x_invoice_duplicate_date"/></span>
        </t>
      </h2>
    </h2>

    <div name="reference" position="attributes">
      <attribute name="t-if">not o.move_type.endswith('_refund') and o.ref</attribute>"
    </div>

    <div name="reference" position="after">
      <div class="col-auto mw-100 mb-2" t-if="o.move_type.endswith('_refund') and o.ref">
        <strong>Correction reason:</strong>
        <p class="m-0" t-field="o.ref"/>
      </div>
      <div class="col-auto mw-100 mb-2" t-if="o.move_type.endswith('_refund') and o.refund_invoice_id">
        <strong>Corrected invoice:</strong>
        <p class="m-0" t-out="o.refund_invoice_id.name"/>
      </div>
      <div class="col-auto mw-100 mb-2" t-if="o.move_type.endswith('_refund') and o.invoice_date">
        <strong>Original invoice date:</strong>
        <p class="m-0" t-out="o.refund_invoice_id.invoice_date"/>
      </div>
    </div>

    <!-- Final invoice hide downpayment lines -->
    <t t-set="lines" position="replace">
      <t t-set="lines"
         t-value="o.invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"/>
      <t t-if="o.final_source_id">
        <t t-set="lines" t-value="lines.filtered(lambda l: l.quantity >= 0)"/>
      </t>
    </t>

    <!-- Final invoice lines label -->
    <table name="invoice_line_table" position="before">
      <h4 t-if="o.final_source_id" style="margin-top: 20px;">Invoiced Products:</h4>
    </table>


    <!-- correction invoice hide original lines -->
    <!-- refund invoice hide original lines -->
    <!-- advance invoice hide original lines -->
    <table name="invoice_line_table" position="attributes">
      <attribute name="t-if">(o.move_type not in ['in_refund', 'out_refund'] and not o.advance_source_id) or (o.move_type == 'in_refund' and not o.advance_source_id)</attribute>
    </table>

    <!-- invoice lines thead background -->
    <xpath expr="//table[@name='invoice_line_table']/thead/tr" position="attributes">
      <attribute name="class">bg-200</attribute>
    </xpath>

    <!-- Original sale order lines (used in advance invoice) -->
    <table name="invoice_line_table" position="before">
      <div t-if="o.advance_source_id" name="table_sale_order_data">
        <t t-set="order" t-value="o.advance_source_id or o.final_source_id"/>
        <h4>Sale Order Data (<span t-field="order.name"/>):</h4>
        <table class="table table-sm correction-table" name="advance_invoice_sale_lines" t-if="order">
          <thead class="before-correction">
            <tr class="bg-200">
              <t t-set="colspan" t-value="6"/>
              <th name="th_description" class="text-left"><span>Description</span></th>
              <th name="th_quantity" class="text-right"><span>Quantity</span></th>
              <th name="th_priceunit"
                  t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                <span>Unit Price NET</span></th>
              <th name="th_price_unit" t-if="display_discount"
                  t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                <span>Disc.%</span>
                <!-- TODO: remove in master -->
                <t t-set="colspan" t-value="colspan+1"/>
              </th>
              <th name="th_taxes"
                  t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                <span>Taxes</span>
              </th>
              <th name="th_subtotal" class="text-right">
                <span groups="account.group_show_line_subtotals_tax_excluded">NET amount</span>
                <span groups="account.group_show_line_subtotals_tax_included">GROSS amount</span>
              </th>
            </tr>
          </thead>
          <tbody class="invoice_tbody">
            <t t-set="current_subtotal" t-value="0"/>
            <t t-set="tax_info" t-value="{}"/>
            <t t-foreach="order.order_line.filtered(lambda l: not l.is_downpayment)" t-as="line">
              <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"
                 groups="account.group_show_line_subtotals_tax_excluded"/>
              <t t-set="current_subtotal" t-value="current_subtotal + line.price_total"
                 groups="account.group_show_line_subtotals_tax_included"/>
              <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
                <t t-if="not line.display_type" name="account_invoice_line_accountable">
                  <td name="account_invoice_line_name"><span t-field="line.name"/></td>
                  <td class="text-right">
                    <span t-field="line.product_uom_qty"/>
                    <span t-field="line.product_uom" groups="uom.group_uom"/>
                  </td>
                  <td t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                    <span t-out="(line.price_subtotal / line.product_uom_qty) if line.product_uom_qty else 0"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </td>
                  <td t-if="display_discount"
                      t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                    <span t-field="line.discount"/>
                  </td>
                  <td t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                    <span t-out="', '.join([tax.description for tax in line.tax_id])" id="line_tax_id"/>
                  </td>
                  <td class="text-right o_price_total">
                    <span t-field="line.price_subtotal"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'
                          groups="account.group_show_line_subtotals_tax_excluded"/>
                    <span t-field="line.price_total"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'
                          groups="account.group_show_line_subtotals_tax_included"/>
                  </td>
                </t>
                <t t-if="line.display_type == 'line_section'">
                  <td colspan="99">
                    <span t-field="line.name"/>
                  </td>
                  <t t-set="current_section" t-value="line"/>
                  <t t-set="current_subtotal" t-value="0"/>
                </t>
                <t t-if="line.display_type == 'line_note'">
                  <td colspan="99">
                    <span t-field="line.name"/>
                  </td>
                </t>
              </tr>
            </t>
          </tbody>
        </table>

        <!-- Summary of Sale Order (For advance invoice) -->
        <t t-set="advance_vat_to_pln"
           t-value="order.currency_id.name != 'PLN' and o.company_id.currency_id.name == 'PLN'"/>
        <div id="advance_order_total" class="row">
          <div class="col-4"/>
          <div class="col-8">
            <div><strong class="mt-4">Sale Order Summary:</strong></div>
            <t t-set="taxes_groups" t-value="order.get_taxes_groups()"/>
            <table class="table table-sm table-condensed">
              <tr class="bg-200">
                <td class="text-left">
                  <strong>VAT rate</strong>
                </td>
                <td class="text-right">
                  <strong>NET amount</strong>
                </td>
                <td class="text-right">
                  <strong>VAT amount</strong>
                </td>
                <td class="text-right">
                  <strong>GROSS amount</strong>
                </td>
              </tr>
              <t t-foreach="taxes_groups.keys()" t-as="tax_group">
                <tr>
                  <td class="text-left" style="white-space: nowrap;">
                    <strong>
                      <span t-raw="tax_group"/>
                    </strong>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <strong>
                      <span t-raw="taxes_groups[tax_group]['base']"
                            t-options='{"widget": "monetary", "display_currency": order.currency_id}'/>
                    </strong>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <strong>
                      <span t-raw="taxes_groups[tax_group]['tax']"
                            t-options='{"widget": "monetary", "display_currency": order.currency_id}'/>
                    </strong>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <strong>
                      <span t-raw="taxes_groups[tax_group]['total']"
                            t-options='{"widget": "monetary", "display_currency": order.currency_id}'/>
                    </strong>
                  </td>
                </tr>
              </t>
              <t t-set="tax_summary" t-value="order.x_get_taxes_summary()"/>
              <tr class="border-black o_total" style="border-bottom: 1px solid #000000;">
                <td class="text-left" style="white-space: nowrap;">
                  <strong>Total</strong>
                </td>
                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="tax_summary['base']" t-options='{"widget": "monetary", "display_currency": order.currency_id}'/>
                  </strong>
                </td>
                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="tax_summary['tax']" t-options='{"widget": "monetary", "display_currency": order.currency_id}'/>
                  </strong>
                </td>
                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="tax_summary['total']" t-options='{"widget": "monetary", "display_currency": order.currency_id}'/>
                  </strong>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </table>

    <!-- advance invoice summary -->
    <table name="invoice_line_table" position="after">
      <t t-set="connected_advance"
         t-value="o.advance_invoices_ids or o.advance_source_id.advance_invoices.filtered(lambda i: i.id != o.id)"/>
      <t t-if="connected_advance">
        <strong class="mt-4">Connected Advance Invoices:</strong>
        <table class="table table-sm correction-table">
          <thead class="before-correction">
            <tr class="bg-200">
              <th name="th_inv_name" class="text-left"><span>Invoice Number</span></th>
              <th name="th_inv_date" class="text-left"><span>Invoice Date</span></th>
              <th name="th_inv_net" class="text-right"><span>NET amount</span></th>
              <th name="th_inv_tax" class="text-right"><span>VAT amount</span></th>
              <th name="th_subtotal" class="text-right"><span>GROSS amount</span></th>
            </tr>
          </thead>
          <tbody>
            <t t-foreach="connected_advance" t-as="line">
              <tr>
                <td class="text-left"><span t-field="line.name"/></td>
                <td class="text-left"><span t-field="line.invoice_date"/></td>
                <td class="text-right"><span t-field="line.amount_untaxed"
                                             t-options='{"widget": "monetary", "display_currency": line.currency_id}'/></td>
                <td class="text-right"><span t-field="line.amount_tax"
                                             t-options='{"widget": "monetary", "display_currency": line.currency_id}'/></td>
                <td class="text-right"><span t-field="line.amount_total"
                                             t-options='{"widget": "monetary", "display_currency": line.currency_id}'/></td>
              </tr>
            </t>
          </tbody>
        </table>
      </t>

      <t t-if="o.final_source_id and not o.refund_invoice_id">
        <t t-set="vat_to_pln" t-value="o.currency_id.name != 'PLN' and o.company_id.currency_id.name == 'PLN'"/>
        <div class="row" name="final_table_total_with_advances">
          <div class="col-4"/>
          <div class="col-8">
            <strong class="mt-4">Total after taking into account advances:</strong>
            <t t-set="final_invoice_summary" t-value="o.get_final_invoice_summary()"/>
            <table class="table table-sm table-condensed" style="page-break-inside: avoid;">
              <tr class="border-black bg-200">
                <td class="text-left">
                  <strong>VAT rate</strong>
                </td>
                <td class="text-right">
                  <strong>NET amount</strong>
                </td>
                <td class="text-right">
                  <strong>VAT amount</strong>
                </td>
                <td t-if="vat_to_pln">
                  <strong>VAT amount in PLN</strong>
                </td>
                <td class="text-right">
                  <strong>GROSS amount</strong>
                </td>
              </tr>
              <t t-foreach="final_invoice_summary['tax_list']" t-as="tax">
                <tr style="border-bottom: 1px solid #dddddd;">
                  <td style="white-space: nowrap;">
                    <span t-out="tax['tax']"/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <span t-out="tax['netto']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <span t-out="tax['tax_value']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;" t-if="vat_to_pln">
                    <span t-out="tax['in_pln']"
                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <span t-out="tax['brutto']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </td>
                </tr>
              </t>
              <tr class="border-black o_total" style="border-bottom: 1px solid #000000;">
                <td>
                  <strong>Total</strong>
                </td>
                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="final_invoice_summary['netto']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </strong>
                </td>
                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="final_invoice_summary['tax_value']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </strong>
                </td>
                <td class="text-right" style="white-space: nowrap;" t-if="vat_to_pln">
                  <strong>
                    <span t-out="final_invoice_summary['in_pln']"
                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                  </strong>
                </td>

                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="final_invoice_summary['brutto']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </strong>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </t>

      <div t-if="o.advance_source_id">
        <div style="page-break-inside: avoid;" class="row mt-4" name="table_advance_payment_settlement">
          <div class="col-8 offset-4">
            <div><strong>Settlement of received advance payment according to tax rates:</strong></div>
            <table class="table table-sm table-condensed">
              <!-- 15->16: renamed tax_totals_json field to tax_totals -->
              <!-- <t t-set="tax_totals" t-value="json.loads(o.tax_totals_json)"/> -->
              <t t-set="tax_totals" t-value="o.tax_totals"/>
              <tr class="bg-200">
                <td>
                  <strong>VAT rate</strong>
                </td>
                <td class="text-right">
                  <strong>NET amount</strong>
                </td>
                <td class="text-right">
                  <strong>VAT amount</strong>
                </td>
                <td t-if="vat_to_pln" class="text-right">
                  <strong>VAT amount in PLN</strong>
                </td>
                <td class="text-right">
                  <strong>GROSS amount</strong>
                </td>
              </tr>

              <t t-foreach="tax_totals['subtotals']" t-as="subtotal">
                <t t-foreach="tax_totals['groups_by_subtotal'][subtotal['name']]"
                   t-as="amount_by_group">
                  <tr style="border-bottom: 1px solid #dddddd;">
                    <td style="white-space: nowrap;">
                      <span t-out="amount_by_group['tax_group_name']"/>
                    </td>
                    <td class="text-right" style="white-space: nowrap;">
                      <span t-out="amount_by_group['formatted_tax_group_base_amount']"/>
                    </td>
                    <td class="text-right" style="white-space: nowrap;">
                      <span t-out="amount_by_group['formatted_tax_group_amount']"/>
                    </td>
                    <td class="text-right" style="white-space: nowrap;" t-if="vat_to_pln">
                      <span t-out="amount_by_group['x_formatted_tax_group_amount_in_pln']"/>
                    </td>
                    <td class="text-right" style="white-space: nowrap;">
                      <span t-out="amount_by_group['x_formatted_tax_group_total_amount']"/>
                    </td>
                  </tr>
                </t>
              </t>
            </table>
          </div>
        </div>

        <div id="advance_order_total" class="row mt-4" t-if="o.advance_source_id"
             style="page-break-inside: avoid;">
          <div class="col-4"/>
          <div class="col-8">
            <div><strong>Advance Invoice Summary / Amount To Pay:</strong></div>
            <t t-set="x_invoice_amount_summary" t-value="o.x_get_invoice_amount_summary()"/>
            <table class="table table-sm table-condensed" style="page-break-inside: avoid;">
              <tr class="bg-200">
                <td class="text-right">
                  <strong>NET amount</strong>
                </td>
                <td class="text-right">
                  <strong>VAT amount</strong>
                </td>
                <td t-if="vat_to_pln" class="text-right">
                  <strong>VAT amount in PLN</strong>
                </td>
                <td class="text-right">
                  <strong>GROSS amount</strong>
                </td>
              </tr>
              <tr class="border-black o_total" style="border-bottom: 1px solid #000000;">
                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="x_invoice_amount_summary['base']"
                          t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                  </strong>
                </td>
                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="x_invoice_amount_summary['amount']"
                          t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                  </strong>
                </td>
                <td class="text-right" style="white-space: nowrap;" t-if="vat_to_pln">
                  <strong>
                    <span t-out="x_invoice_amount_summary['in_pln']"
                          t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                  </strong>
                </td>

                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="x_invoice_amount_summary['total']"
                          t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                  </strong>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </div>

    </table>

    <!-- Final invoice lines without downpayments or Correction invoice with advance_source_id then, show downpayments -->
    <table name="invoice_line_table" position="after">
      <t t-if="o.final_source_id or (o.refund_invoice_id and o.advance_source_id)">
        <t t-set="vat_to_pln" t-value="o.currency_id.name != 'PLN' and o.company_id.currency_id.name == 'PLN'"/>
        <div class="row">
          <div class="col-4"/>
          <div class="col-8">
            <!--Show downpayments if it is not final invoice, and it is correction with downpayments-->
            <t t-set="final_invoice_summary"
               t-value="o.get_final_invoice_summary(with_downpayments=(not o.final_source_id and o.refund_invoice_id and o.advance_source_id))"/>

            <table class="table table-sm table-condensed" style="page-break-inside: avoid;">
              <tr class="border-black bg-200">
                <td class="text-left">
                  <strong>VAT rate</strong>
                </td>
                <td class="text-right">
                  <strong>NET amount</strong>
                </td>
                <td class="text-right">
                  <strong>VAT amount</strong>
                </td>
                <td t-if="vat_to_pln" class="text-right">
                  <strong>VAT amount in PLN</strong>
                </td>
                <td class="text-right">
                  <strong>GROSS amount</strong>
                </td>
              </tr>
              <t t-foreach="final_invoice_summary['tax_list']" t-as="tax">
                <tr style="border-bottom: 1px solid #dddddd;">
                  <td style="white-space: nowrap;">
                    <span t-out="tax['tax']"/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <span t-out="tax['netto']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <span t-out="tax['tax_value']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;" t-if="vat_to_pln">
                    <span t-out="tax['in_pln']"
                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <span t-out="tax['brutto']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </td>
                </tr>
              </t>
              <tr class="border-black o_total" style="border-bottom: 1px solid #000000;">
                <td>
                  <strong>Total</strong>
                </td>
                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="final_invoice_summary['netto']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </strong>
                </td>
                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="final_invoice_summary['tax_value']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </strong>
                </td>
                <td class="text-right" style="white-space: nowrap;" t-if="vat_to_pln">
                  <strong>
                    <span t-out="final_invoice_summary['in_pln']"
                          t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                  </strong>
                </td>

                <td class="text-right" style="white-space: nowrap;">
                  <strong>
                    <span t-out="final_invoice_summary['brutto']"
                          t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                  </strong>
                </td>
              </tr>
            </table>
          </div>
        </div>
      </t>
    </table>

    <!-- new detail tables -->
    <table name="invoice_line_table" position="after">
      <table class="table table-sm correction-table" name="invoice_lines_before_correction"
             t-if="o.move_type in ['in_refund', 'out_refund'] and o.refund_invoice_id">
        <thead class="before-correction">
          <tr class="table-title">
            <th t-att-colspan="6 if display_discount else 5"><span>Items prior to correction:</span></th>
          </tr>
          <tr class="bg-200">
            <th name="th_description" class="text-left"><span>Description</span></th>
            <th name="th_quantity" class="text-right"><span>Quantity</span></th>
            <th name="th_priceunit"
                t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
              <span>Unit Price NET</span>
            </th>
            <th name="th_price_unit" t-if="display_discount"
                t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
              <span>Disc.%</span>
            </th>
            <th name="th_taxes"
                t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
              <span>Taxes</span>
            </th>
            <th name="th_subtotal" class="text-right">
              <span groups="account.group_show_line_subtotals_tax_excluded">NET amount</span>
              <span groups="account.group_show_line_subtotals_tax_included">GROSS amount</span>
            </th>
          </tr>
        </thead>
        <tbody class="invoice_tbody">
          <t t-set="current_subtotal" t-value="0"/>
          <t t-foreach="o.original_invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"
             t-as="line">
            <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"
               groups="account.group_show_line_subtotals_tax_excluded"/>
            <t t-set="current_subtotal" t-value="current_subtotal + line.price_total"
               groups="account.group_show_line_subtotals_tax_included"/>

            <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
              <t t-if="not line.display_type" name="account_invoice_line_accountable">
                <td name="account_invoice_line_name"><span t-field="line.name"/></td>
                <td class="text-right">
                  <span t-field="line.quantity"/>
                  <span t-field="line.product_uom_id" groups="uom.group_uom"/>
                </td>
                <td t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                  <span t-out="line.x_get_net_price_unit()"
                        t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                </td>
                <td t-if="display_discount"
                    t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                  <span t-field="line.discount"/>
                </td>
                <td t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                  <span t-out="', '.join([x.description or x.name for x in line.tax_ids])"
                        id="line_tax_ids"/>
                </td>
                <td class="text-right o_price_total">
                  <span t-field="line.price_subtotal"
                        t-options='{"widget": "monetary", "display_currency": o.currency_id}'
                        groups="account.group_show_line_subtotals_tax_excluded"/>
                  <span t-field="line.price_total"
                        t-options='{"widget": "monetary", "display_currency": o.currency_id}'
                        groups="account.group_show_line_subtotals_tax_included"/>
                </td>
              </t>
              <t t-if="line.display_type == 'line_section'">
                <td colspan="99">
                  <span t-field="line.name"/>
                </td>
                <t t-set="current_section" t-value="line"/>
                <t t-set="current_subtotal" t-value="0"/>
              </t>
              <t t-if="line.display_type == 'line_note'">
                <td colspan="99">
                  <span t-field="line.name"/>
                </td>
              </t>
            </tr>
          </t>
        </tbody>
      </table>
      <table class="table table-sm correction-table" name="invoice_lines_after_correction"
             t-if="o.move_type in ['in_refund', 'out_refund'] and o.refund_invoice_id">
        <thead class="after-correction">
          <tr class="table-title">
            <th t-att-colspan="6 if display_discount else 5"><span>Items after correction:</span></th>
          </tr>
          <tr class="bg-200">
            <th name="th_description" class="text-left"><span>Description</span></th>
            <th name="th_quantity" class="text-right"><span>Quantity</span></th>
            <th name="th_priceunit"
                t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
              <span>Unit Price NET</span>
            </th>
            <th name="th_price_unit" t-if="display_discount"
                t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
              <span>Disc.%</span>
            </th>
            <th name="th_taxes"
                t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
              <span>Taxes</span>
            </th>
            <th name="th_subtotal" class="text-right">
              <span groups="account.group_show_line_subtotals_tax_excluded">NET amount</span>
              <span groups="account.group_show_line_subtotals_tax_included">GROSS amount</span>
            </th>
          </tr>
        </thead>
        <tbody class="invoice_tbody">
          <t t-foreach="o.corrected_invoice_line_ids.sorted(key=lambda l: (-l.sequence, -l.id), reverse=True)"
             t-as="line">
            <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
              <t t-if="not line.display_type" name="account_invoice_line_accountable">
                <td name="account_invoice_line_name"><span t-field="line.name"/></td>
                <td class="text-right">
                  <span t-field="line.x_quantity_reverse"/>
                  <span t-field="line.product_uom_id" groups="uom.group_uom"/>
                </td>
                <td t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                  <span t-out="line.x_get_net_price_unit()"
                        t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                </td>
                <td t-if="display_discount"
                    t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                  <span t-field="line.discount"/>
                </td>
                <td t-attf-class="text-left {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                  <span t-out="', '.join([x.description or x.name for x in line.tax_ids])" id="line_tax_ids"/>
                </td>
                <td class="text-right o_price_total">
                  <span t-field="line.x_price_subtotal_reverse"
                        t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"
                        groups="account.group_show_line_subtotals_tax_excluded"/>
                  <span t-field="line.x_price_total_reverse"
                        t-options='{"widget": "monetary", "display_currency": o.currency_id}'
                        groups="account.group_show_line_subtotals_tax_included"/>
                </td>
              </t>
              <t t-if="line.display_type == 'line_section'">
                <td colspan="99">
                  <span t-field="line.name"/>
                </td>
                <t t-set="current_section" t-value="line"/>
                <t t-set="current_subtotal" t-value="0"/>
              </t>
              <t t-if="line.display_type == 'line_note'">
                <td colspan="99">
                  <span t-field="line.name"/>
                </td>
              </t>
            </tr>
          </t>
        </tbody>
      </table>
    </table>

    <!-- tax summary table -->
    <xpath expr="//div[@id='total']" position="replace">
      <t t-set="vat_to_pln" t-value="o.currency_id.name != 'PLN' and o.company_id.currency_id.name == 'PLN'"/>
      <div id="total" class="row" t-if="not o.advance_source_id and not o.final_source_id">
        <div class="col-4"/>
        <div class="col-8">
          <table class="table table-sm table-condensed" style="page-break-inside: avoid;">
            <!-- 15->16: renamed tax_totals_json field to tax_totals -->
            <!-- <t t-set="tax_totals" t-value="json.loads(o.tax_totals_json)"/> -->
            <t t-set="tax_totals" t-value="o.tax_totals"/>
            <tr class="border-black bg-200">
              <td class="text-left">
                <strong>VAT rate</strong>
              </td>
              <td class="text-right">
                <strong>NET amount</strong>
              </td>
              <td class="text-right">
                <strong>VAT amount</strong>
              </td>
              <td t-if="vat_to_pln" class="text-right">
                <strong>VAT amount in PLN</strong>
              </td>
              <td class="text-right">
                <strong>GROSS amount</strong>
              </td>
            </tr>

            <t t-foreach="tax_totals['subtotals']" t-as="subtotal">
              <t t-foreach="tax_totals['groups_by_subtotal'][subtotal['name']]" t-as="amount_by_group">
                <tr style="border-bottom: 1px solid #dddddd;">
                  <td style="white-space: nowrap;">
                    <span t-out="amount_by_group['tax_group_name']"/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <span t-out="amount_by_group['formatted_tax_group_base_amount']"/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <span t-out="amount_by_group['formatted_tax_group_amount']"/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;" t-if="vat_to_pln">
                    <span t-out="amount_by_group['x_formatted_tax_group_amount_in_pln']"/>
                  </td>
                  <td class="text-right" style="white-space: nowrap;">
                    <span t-out="amount_by_group['x_formatted_tax_group_total_amount']"/>
                  </td>
                </tr>
              </t>
            </t>
            <tr class="border-black o_total" style="border-bottom: 1px solid #000000;">
              <td>
                <strong>Total</strong>
              </td>
              <td class="text-right" style="white-space: nowrap;">
                <strong>
                  <span t-out="o.x_invoice_sign * abs(tax_totals['amount_untaxed'])"
                        t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                </strong>
              </td>
              <td class="text-right" style="white-space: nowrap;">
                <strong>
                  <span t-out="o.x_invoice_sign * abs(tax_totals['x_tax_amount'])"
                        t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                </strong>
              </td>
              <td class="text-right" style="white-space: nowrap;" t-if="vat_to_pln">
                <strong>
                  <span t-out="o.x_invoice_sign * abs(tax_totals['x_tax_amount_in_pln'])"
                        t-options="{'widget': 'monetary', 'display_currency': o.company_id.currency_id}"/>
                </strong>
              </td>

              <td class="text-right" style="white-space: nowrap;">
                <strong>
                  <span t-out="o.x_invoice_sign * abs(tax_totals['amount_total'])"
                        t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                </strong>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </xpath>

    <!-- bank transfer details -->
    <!-- 15->16: added xpath in place of p name -->
    <!-- <p name="payment_term" position="after"> -->
    <xpath expr="//*[@name='payment_term']" position="after">
      <p>
        <t t-if="o.partner_bank_id and o.amount_residual and o.invoice_date != o.invoice_date_due"
          name="partner_bank_id">
          Bank Account Number: <span t-field="o.partner_bank_id.acc_number"/>
          <span t-if="o.currency_id.name != 'PLN' and o.partner_bank_id.bank_bic">
            &amp;bull;&amp;nbsp;BIC/SWIFT: <span t-field="o.partner_bank_id.bank_bic"/>
          </span>
        </t>
      </p>
    </xpath>

    <!-- sÅ‚ownie -->
    <xpath expr="//*[@name='payment_term']" position="before">
      <t t-set="amount_total_in_words" t-value="o.x_num2words(abs(o.amount_total), o.currency_id.name)"/>

      <p id="total-in-words" t-if="amount_total_in_words">
        In words: <span t-out="amount_total_in_words"/>
      </p>
    </xpath>

    <!-- payment communication -->
    <xpath expr="//p[@name='payment_communication']" position="attributes">
      <attribute name="t-if">o.move_type in ('out_invoice', 'in_refund') and o.payment_reference and o.invoice_date != o.invoice_date_due</attribute>
      <attribute name="class" separator=" " add="x_mtl"/>
    </xpath>

    <!-- SPLIT PAYMENT MECHANISM annotation -->
    <xpath expr="//p[@name='payment_communication']" position="before">
      <t t-if="o.x_is_jpk_mpp()">SPLIT PAYMENT MECHANISM</t>
    </xpath>

  </template>

  <template id="report_invoice_document_with_payments" inherit_id="trilab_invoice.report_invoice_document"
            primary="True">
    <xpath expr="//div[@id='total']/div/table" position="after">
      <!-- 15->16: -->
      <!-- <t t-set="payments_vals" t-value="o._get_reconciled_info_JSON_values()"/> -->
      <t t-set="payments_vals" t-value="o.sudo().invoice_payments_widget and o.sudo().invoice_payments_widget['content'] or []"/>                                            
      <t t-foreach="payments_vals" t-as="payment_vals">
        <div style="text-align: right;">
          <span t-out="payment_vals['amount']"
                t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
          Paid on <t t-out="payment_vals['date']" t-options='{"widget": "date"}'/>
        </div>
        <br/>
      </t>
    </xpath>
  </template>

  <template id="report_invoice" inherit_id="account.report_invoice">
    <t t-call="account.report_invoice_document" t-lang="lang" position="attributes">
      <attribute name="t-if">o.company_id.country_id.code != 'PL'</attribute>
    </t>
    <t t-call="account.report_invoice_document" t-lang="lang" position="after">
      <t t-call="trilab_invoice.report_invoice_document" t-lang="lang"
         t-if="o.company_id.country_id.code == 'PL'"/>
    </t>
  </template>

  <template id="report_invoice_with_payments" inherit_id="account.report_invoice_with_payments">
    <t t-call="account.report_invoice_document" t-lang="lang" position="attributes">
      <attribute name="t-if">o.company_id.country_id.code != 'PL'</attribute>
    </t>

    <t t-call="account.report_invoice_document" t-lang="lang" position="after">
      <t t-call="trilab_invoice.report_invoice_document_with_payments" t-lang="lang"
         t-if="o.company_id.country_id.code == 'PL'"/>
    </t>
  </template>

</odoo>
